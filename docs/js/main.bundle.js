(()=>{"use strict";let e=document.querySelector(".ad-form"),t=e.querySelector("#type"),a=e.querySelector("#price");"flat"==t.value&&(a.placeholder=1e3),e.addEventListener("submit",(t=>{i(),t.preventDefault();const a=new FormData(t.target);s&&fetch("https://23.javascript.pages.academy/keksobooking",{method:"POST",body:a}).then((e=>{if(e.ok)return console.log(e.json());throw new Error})).then((()=>{r(),e.reset(),p()})).catch(o)}));const r=()=>{let e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.body.appendChild(e),l(e)},o=()=>{let e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),t=e.querySelector(".error-button");document.body.appendChild(e),l(e,t)},l=(e,t)=>{const a=t=>{"Escape"==t.code&&e.remove(),document.removeEventListener("keydown",a)},r=()=>{e.remove(),document.removeEventListener("click",r)};document.addEventListener("keydown",a),document.addEventListener("click",r),t&&t.addEventListener("click",(()=>{e.remove()}))};a.addEventListener("input",(()=>{if(a.value>1e6)a.setCustomValidity("Максимальная цена: 1 000 000 руб.");else switch(t.value){case"bungalow":a.value<0?a.setCustomValidity("Минимальная цена за ночь для бунгало - 0 руб."):a.setCustomValidity("");break;case"flat":a.value<1e3?a.setCustomValidity("Минимальная цена за ночь для квартиры - 1000 руб."):a.setCustomValidity("");break;case"house":a.value<5e3?a.setCustomValidity("Минимальная цена за ночь для дома - 5000 руб."):a.setCustomValidity("");break;case"palace":a.value<1e4?a.setCustomValidity("Минимальная цена за ночь для дворца - 10000 руб."):a.setCustomValidity("")}a.reportValidity()})),t.addEventListener("change",(()=>{switch(t.value){case"bungalow":a.placeholder=0,a.value<0?a.setCustomValidity("Минимальная цена за ночь для бунгало - 0 руб."):a.setCustomValidity("");break;case"flat":a.placeholder=1e3,a.value<1e3?a.setCustomValidity("Минимальная цена за ночь для квартиры - 1000 руб."):a.setCustomValidity("");break;case"house":a.placeholder=5e3,a.value<5e3?a.setCustomValidity("Минимальная цена за ночь для дома - 5000 руб."):a.setCustomValidity("");break;case"palace":a.placeholder=1e4,a.value<1e4?a.setCustomValidity("Минимальная цена за ночь для дворца - 10000 руб."):a.setCustomValidity("")}a.reportValidity()}));let s,n=document.querySelector("#address");const i=()=>{if(""==n.value){let e=document.createElement("p");e.style.width=window.getComputedStyle(n).width,e.textContent="Выберите адрес объявления красным маркером на карте",e.style.padding="5px",e.style.backgroundColor="#ff6547",e.style.fontWeight="bold",e.style.marginTop="3px",e.style.borderRadius="5px",n.style.boxShadow="0 0 2px 2px #ff6547",n.insertAdjacentElement("afterend",e),setTimeout((()=>{n.style.boxShadow="",e.remove()}),4e3)}else s=!0},d=e.querySelector("#title");d.addEventListener("input",(()=>{const e=d.value.length;e<30?d.setCustomValidity("Еще "+(30-e)+" символов."):e>100?d.setCustomValidity("Удалите лишние "+(e-100)+" символы."):d.setCustomValidity(""),d.reportValidity()}));const c=e.querySelector("#room_number"),u=e.querySelector("#capacity"),p=()=>{if("1"==c.value)for(let e of u.children)e.value!=c.value?e.setAttribute("disabled",""):u.value=c.value};p();const m=e=>{e.hasAttribute("disabled","")||e.setAttribute("disabled","")},y=e=>{e.hasAttribute("disabled","")&&e.removeAttribute("disabled","")};c.addEventListener("change",(()=>{switch(c.value){case"1":for(let e of u.children)e.value!=c.value?m(e):y(e);u.value!=c.value?u.setCustomValidity("1 комната доступна только для 1 гостя"):u.setCustomValidity(""),u.addEventListener("change",(()=>{"1"==u.value&&u.setCustomValidity("")}));break;case"2":for(let e of u.children)e.value>c.value||"0"==e.value?m(e):y(e);u.value>c.value||"0"==u.value?u.setCustomValidity("2 комнаты доступны только для 1 или 2 гостей"):u.setCustomValidity(""),u.addEventListener("change",(()=>{"2"!=u.value&&"1"!=u.value||u.setCustomValidity("")}));break;case"3":for(let e of u.children)"0"==e.value?m(e):y(e);"0"==u.value?u.setCustomValidity("3 комнаты доступны только для 1-3 гостей"):u.setCustomValidity(""),u.addEventListener("change",(()=>{"0"!=u.value&&u.setCustomValidity("")}));break;case"100":for(let e of u.children)e.value>0?m(e):y(e);u.value>"0"?u.setCustomValidity("100 комнат доступны только не для гостей"):u.setCustomValidity(""),u.addEventListener("change",(()=>{"0"==u.value&&u.setCustomValidity("")}))}u.reportValidity()}));let h=e.querySelector("#timein"),v=e.querySelector("#timeout");h.addEventListener("change",(()=>{v.value=h.value})),v.addEventListener("change",(()=>{h.value=v.value})),e.classList.add("ad-form--disabled");let f=e.querySelectorAll("fieldset");for(let e of f)e.setAttribute("disabled","");let g=document.querySelector(".map__filters");g.classList.add("map__filters--disabled");for(let e of g.children)e.setAttribute("disabled","");document.querySelector(".ad-form__reset").addEventListener("click",(t=>{t.preventDefault(),e.reset(),p()}));let b=e.querySelector(".ad-form-header__preview").children[0],C=e.querySelector(".ad-form-header__input");C.addEventListener("change",(()=>{const e=C.files[0],t=["gif","jpeg","png","jpg"];if(e){const a=e.name.toLowerCase();if(t.some((e=>a.endsWith(e)))){const t=new FileReader;t.addEventListener("load",(()=>{b.src=t.result})),t.readAsDataURL(e)}}}));let S=e.querySelector(".ad-form__photo"),q=e.querySelector(".ad-form__input");q.addEventListener("change",(()=>{let e=S.children;if(e.length>0)for(let t=e.length-1;e.length>0;t--)e[t].remove();const t=Array.from(q.files);if(t.length>0){const e=["gif","jpeg","png","jpg"];t.forEach((t=>{const a=t.name.toLowerCase();if(e.some((e=>a.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{let t=document.createElement("img");t.style.width="70px",t.style.height="70px",t.style.objectFit="cover",t.src=e.result,S.style.display="flex",S.appendChild(t)})),e.readAsDataURL(t)}}))}}));const _=L.map("map-canvas").on("load",(()=>{(()=>{e.classList.remove("ad-form--disabled");for(let e of f)e.removeAttribute("disabled","")})(),(()=>{g.classList.remove("map__filters--disabled");for(let e of g.children)e.removeAttribute("disabled","")})()})).setView({lat:35.6854,lng:139.722},13);L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(_);const w=L.icon({iconUrl:"leaflet/img/main-pin.svg",iconSize:[52,52],iconAnchor:[26,52],shadowUrl:"leaflet/leaflet/images/marker-shadow.png",shadowSize:[68,95],shadowAnchor:[22,94]}),E=L.icon({iconUrl:"leaflet/img/pin.svg",iconSize:[40,40],iconAnchor:[20,40],shadowUrl:"leaflet/leaflet/images/marker-shadow.png",shadowSize:[58,75],shadowAnchor:[20,76]});let V=document.querySelector("#address");L.marker({lat:35.6894,lng:139.735},{draggable:!0,icon:w}).on("moveend",(e=>{V.value=`${e.target.getLatLng().lat.toFixed(5)}, ${e.target.getLatLng().lng.toFixed(5)}`})).addTo(_);const k=(e,t)=>{let a;return()=>{clearTimeout(a),a=setTimeout(e,t)}};let x=g.querySelector("#housing-type"),A=g.querySelector("#housing-price"),j=g.querySelector("#housing-rooms"),T=g.querySelector("#housing-guests"),$=g.querySelector(".map__features");const z=(e,t)=>{let a;switch(t){case"any":a=!0;break;case"low":e<1e4&&(a=!0);break;case"middle":e>1e4&&e<5e4&&(a=!0);break;case"high":e>5e4&&(a=!0)}return a},F=(e,t)=>{let a;return(t>3||"any"==t)&&(a=!0),t==e&&(a=!0),a},U=(e,t)=>{let a;return"any"!=t||e>10||(a=!0),t==e&&(a=!0),0==t&&e>10&&(a=!0),a},D=e=>{let t,a=Array.from($.querySelectorAll("input:checked"));return!!e&&(t=e.join(),a.every((e=>t.includes(e.value))))};var R,N;R=e=>{let t=(()=>{let e=document.querySelector("#card").content.querySelector(".popup");const t=e=>{let t=0;return e.offer.type==x.value&&t++,z(e.offer.price,A.value)&&t++,F(e.offer.rooms,j.value)&&t++,U(e.offer.guests,T.value)&&t++,D(e.offer.features)&&t++,t},a=(e,a)=>t(a)-t(e);let r=[],o=[];return t=>{r.forEach((e=>e.remove())),r=[],o=[],t.slice().sort(a).slice(0,10).forEach((({author:t,offer:a,location:l})=>{let s=e.cloneNode(!0);s.querySelector(".popup__title").textContent=a.title,s.querySelector(".popup__text--address").textContent=a.address,s.querySelector(".popup__text--price").innerHTML=a.price+" <span>₽/ночь</span>",s.querySelector(".popup__type").textContent=(e=>{let t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"};return t.hasOwnProperty(e)?t[e]:void 0})(a.type),s.querySelector(".popup__text--capacity").textContent=`${a.rooms} комнаты для ${a.guests} гостей`,s.querySelector(".popup__text--time").textContent=`Заезд после ${a.checkin}, выезд до ${a.checkout}`;let n=s.querySelector(".popup__features");try{((e,t)=>{for(let a of e){let e=Array.from(a.classList).join();t.some(((r,o)=>{if(e.includes(r))return!0;o==t.length-1&&a.classList.add("visually-hidden")}))}})(n.children,a.features)}catch(e){n.setAttribute("hidden","")}s.querySelector(".popup__description").textContent=a.description;let i=s.querySelector(".popup__photo");try{d=i,a.photos.forEach(((e,t)=>{if(0==t)d.src=e;else{let t=d.cloneNode();t.src=e,d.parentElement.appendChild(t)}}))}catch(e){i.remove();let t=s.querySelector(".popup__photos"),a=document.createElement("p");a.textContent="Нет фотографии",t.appendChild(a)}var d;s.querySelector(".popup__avatar").src=t.avatar;let c=L.marker({lat:l.lat,lng:l.lng},{icon:E});(()=>{let e=!1;return(a.type==x.value||"any"==x.value)&&(e=!0,!!z(a.price,A.value)&&(e=!0,!!F(a.rooms,j.value)&&(e=!0,!!U(a.guests,T.value)&&(e=!0,!!D(a.features)&&(e=!0,e)))))})()&&(o.push(a.type+" "+a.price+" room: "+a.rooms+". guest: "+a.guests+". features: "+a.features),r.push(c),c.addTo(_).bindPopup(s))})),console.log(o)}})();var a;t(e),a=k((()=>t(e)),500),g.children[0].addEventListener("change",(()=>{a()})),(e=>{A.addEventListener("change",(()=>{e()}))})(k((()=>t(e)),500)),(e=>{j.addEventListener("change",(()=>{e()}))})(k((()=>t(e)),500)),(e=>{T.addEventListener("change",(()=>{e()}))})(k((()=>t(e)),500)),(e=>{$.addEventListener("change",(()=>{e()}))})(k((()=>t(e)),500))},N=e=>{let t=document.createElement("p");t.innerHTML="<b>Данные с сервера не загрузились - обновите страницу</b>",t.style.position="absolute",t.style.padding="20px",t.style.top="40%",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor="Crimson",t.style.zIndex="100",document.body.appendChild(t),console.log(e),setTimeout((()=>{t.remove()}),5e3)},fetch("https://23.javascript.pages.academy/keksobooking/data").then((e=>{if(e.ok)return e.json();throw new Error(`${e.status} + ${e.statusText}`)})).then((e=>R(e))).catch((e=>{N(e)}))})();
//# sourceMappingURL=main.bundle.js.map